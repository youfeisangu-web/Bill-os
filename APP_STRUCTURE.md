# Billio アプリケーション構成と機能一覧

## 📱 アプリケーション概要

**アプリ名**: Billio（旧Bill OS）  
**種類**: 企業向けクラウド請求管理プラットフォーム  
**デザイン**: モダンなUI（青と緑のグラデーション、カード型レイアウト）

---

## 🏗️ 技術スタック

### フロントエンド
- **Next.js 16.1.2** (App Router)
- **React 19.2.3**
- **TypeScript 5**
- **Tailwind CSS 4** (カスタムカラー: Billio Blue/Green)
- **Shadcn UI** (UIコンポーネント)
- **Lucide React** (アイコン)

### バックエンド
- **Next.js Server Actions** (データ操作)
- **Prisma ORM 5.10.2** (データベース操作)
- **PostgreSQL** (データベース)

### 認証・セキュリティ
- **Clerk** (認証・認可)
- **Middleware** (ルート保護)

### その他
- **Supabase Storage** (画像アップロード: ロゴ・角印)
- **PapaParse** (CSV解析)
- **string-similarity** (文字列類似度判定)
- **iconv-lite** (文字エンコーディング変換)

---

## 📂 プロジェクト構造

```
Billio/
├── prisma/
│   └── schema.prisma          # データベーススキーマ定義
├── src/
│   ├── app/
│   │   ├── actions/           # Server Actions（データ操作）
│   │   │   ├── client.ts      # 取引先管理
│   │   │   ├── expense.ts     # 経費管理
│   │   │   ├── invoice.ts     # 請求書管理
│   │   │   ├── onboarding.ts  # 初期設定
│   │   │   ├── payment.ts     # 支払い管理
│   │   │   ├── quote.ts       # 見積書管理
│   │   │   ├── settings.ts    # 設定管理
│   │   │   ├── tenant.ts      # 入居者管理
│   │   │   └── tenant-group.ts # プロジェクト/フォルダ管理
│   │   ├── api/
│   │   │   └── reconcile/     # 入金消込API
│   │   │       └── route.ts
│   │   ├── dashboard/         # ダッシュボード関連
│   │   │   ├── client-view.tsx # クライアントコンポーネント
│   │   │   ├── page.tsx        # メインダッシュボード（Server）
│   │   │   ├── clients/        # 取引先管理ページ
│   │   │   ├── expenses/       # 経費管理ページ
│   │   │   ├── invoices/       # 請求書管理ページ
│   │   │   ├── quotes/         # 見積書管理ページ
│   │   │   └── settings/       # 設定ページ
│   │   ├── reconcile/         # 入金消込ページ
│   │   │   └── page.tsx
│   │   ├── sign-in/           # ログインページ
│   │   ├── sign-up/           # 登録ページ
│   │   ├── onboarding/        # 初期設定ページ
│   │   ├── layout.tsx         # ルートレイアウト
│   │   └── globals.css        # グローバルスタイル
│   ├── components/            # Reactコンポーネント
│   │   ├── dashboard-sidebar.tsx  # サイドバー
│   │   ├── delete-tenant-button.tsx
│   │   ├── image-upload.tsx   # 画像アップロード
│   │   ├── invoice-template.tsx
│   │   └── ui/                # Shadcn UIコンポーネント
│   ├── lib/
│   │   ├── prisma.ts          # Prismaクライアント（シングルトン）
│   │   ├── supabase-client.ts # Supabaseクライアント
│   │   ├── validation.ts      # バリデーション関数
│   │   └── __tests__/         # ユニットテスト
│   └── types/
│       └── reconcile.ts       # 型定義
└── .github/workflows/
    └── ci.yml                 # CI/CDパイプライン
```

---

## 🎯 主要機能一覧

### 1. 認証・認可
- ✅ **Clerk認証**: ログイン・登録機能
- ✅ **日本語ローカライゼーション**: Clerk UIが日本語表示
- ✅ **Middleware保護**: `/dashboard`と`/admin`ルートを保護
- ✅ **Server Actions認証**: すべてのデータ操作で認証チェック

### 2. ダッシュボード（`/dashboard`）
- ✅ **KPIカード表示**:
  - 請求総額（Monthly ARR）
  - 入金済み（円形グラフ、パーセンテージ）
  - 未収金額
- ✅ **月別推移グラフ**: 請求 vs 入金の可視化
- ✅ **近況の活動**: 最新の入金履歴表示
- ✅ **システム状態**: データベース・APIの状態表示
- ✅ **アクションボタン**:
  - CSVインポート（AI消込）
  - AI通帳読み取り（Beta、未実装）
  - 領収書発行（未実装）

### 3. プロジェクト/フォルダ管理
- ✅ **プロジェクト作成**: フォルダ（グループ）の作成
- ✅ **プロジェクト一覧**: サイドバーに表示
- ✅ **プロジェクト選択**: URLパラメータで絞り込み
- ✅ **プロジェクト削除**: 削除時は入居者をフォルダなしに移動

### 4. 取引先/入居者管理
- ✅ **取引先登録**: 名前、フリガナ、月額請求、所属プロジェクト
- ✅ **取引先一覧**: テーブル形式で表示
- ✅ **取引先削除**: 確認ダイアログ付き
- ✅ **プロジェクト別表示**: 選択したプロジェクトの取引先のみ表示

### 5. 入金消込（AIマッチング）（`/reconcile`）
- ✅ **CSVファイルアップロード**: Shift_JIS対応
- ✅ **口座振替チェック**: 収納代行会社（リコーリースなど）の自動判定
- ✅ **金額一致チェック**: データベースの取引先と金額を照合
- ✅ **名前類似度判定**: `string-similarity`でフリガナの類似度を計算（閾値: 0.6）
- ✅ **結果表示**: マッチング結果をテーブルで表示
- ✅ **確定機能**: マッチした入金をデータベースに保存
- ✅ **プロジェクト別処理**: 選択したプロジェクトの取引先のみ対象

### 6. 請求書管理（`/dashboard/invoices`）
- ✅ **請求書作成**: 取引先、日付、明細を入力
- ✅ **請求書一覧**: ステータス別に表示
- ✅ **請求書詳細**: PDF表示、編集、削除
- ✅ **見積書からの変換**: 見積書を請求書に変換
- ✅ **自動番号付与**: 設定に基づいて請求書番号を自動生成

### 7. 見積書管理（`/dashboard/quotes`）
- ✅ **見積書作成**: 取引先、有効期限、明細を入力
- ✅ **見積書一覧**: ステータス別に表示
- ✅ **見積書詳細**: PDF表示、編集、削除
- ✅ **請求書への変換**: ワンクリックで請求書化
- ✅ **オプション項目**: 選択可能な項目を設定可能
- ✅ **操作ログ**: 見積書の変更履歴を記録

### 8. 取引先管理（`/dashboard/clients`）
- ✅ **取引先登録**: 名前、メール、住所
- ✅ **取引先一覧**: テーブル形式で表示
- ✅ **取引先編集**: 情報の更新
- ✅ **取引先削除**: 確認ダイアログ付き

### 9. 経費管理（`/dashboard/expenses`）
- ✅ **経費登録**: タイトル、金額、日付、カテゴリ
- ✅ **経費一覧**: 日付順で表示
- ✅ **経費編集**: 情報の更新
- ✅ **経費削除**: 確認ダイアログ付き

### 10. 設定管理（`/dashboard/settings`）
- ✅ **会社情報**: 会社名、代表者名、住所、電話番号
- ✅ **インボイス登録番号**: T番号の設定
- ✅ **銀行口座情報**: 複数口座の登録・管理
- ✅ **システム設定**: 
  - デフォルト支払い期限
  - 請求書番号プレフィックス
  - 請求書番号開始番号
  - デフォルト税率
- ✅ **ブランディング**: 
  - 会社ロゴ画像アップロード（Supabase Storage）
  - 角印画像アップロード（Supabase Storage）

### 11. 初期設定（`/onboarding`）
- ✅ **初回ログイン時の設定**: 会社情報、銀行口座の登録

---

## 🗄️ データベーススキーマ

### 主要モデル

1. **UserProfile**: ユーザー情報（Clerk連携）
   - 会社情報、設定、ブランディング

2. **TenantGroup**: プロジェクト/フォルダ
   - 名前、作成日時

3. **Tenant**: 取引先/入居者
   - 名前、フリガナ、月額請求、所属プロジェクト

4. **Payment**: 支払い履歴
   - 取引先ID、金額、日付、備考

5. **Client**: 取引先（請求書・見積書用）
   - 名前、メール、住所

6. **Invoice**: 請求書
   - 請求書番号、ステータス、金額、明細

7. **Quote**: 見積書
   - 見積書番号、ステータス、金額、明細、ログ

8. **Expense**: 経費
   - タイトル、金額、日付、カテゴリ

9. **BankAccount**: 銀行口座
   - 銀行名、支店名、口座番号、口座名義

10. **ItemMaster**: 項目マスタ
    - よく使う項目名とデフォルト価格

---

## 🔒 セキュリティ機能

- ✅ **認証チェック**: すべてのServer ActionsとAPIルートで実装
- ✅ **入力値バリデーション**: 型チェック、長さ制限、形式検証
- ✅ **SQLインジェクション対策**: Prisma ORMによるパラメータ化クエリ
- ✅ **ファイルアップロード検証**: 
  - ファイルタイプ検証（画像のみ）
  - ファイルサイズ制限（5MB）
  - ファイル名サニタイゼーション
- ✅ **CSV処理制限**: 
  - ファイルサイズ制限（10MB）
  - 行数制限（10,000行）
- ✅ **エラーハンドリング**: 詳細なエラー情報をユーザーに表示しない

---

## 🧪 テスト

- ✅ **ユニットテスト**: Vitestで実装
  - 入金消込機能（8テスト）
  - 支払い管理機能（6テスト）
  - 入居者管理機能（7テスト）
- ✅ **型チェック**: TypeScriptの型エラー検証
- ✅ **CI/CD**: GitHub Actionsで自動テスト・ビルド

---

## 🎨 デザインシステム

### カラーパレット（Billio）
- **Billio Blue**: `#3b82f6` (メイン)
- **Billio Green**: `#22c55e` (アクセント)
- **Billio Background**: `#f8fafc` (背景)
- **Billio Card**: `#ffffff` (カード背景)
- **Billio Text**: `#1e293b` (テキスト)

### UIコンポーネント
- カード型レイアウト（角丸、シャドウ）
- グラデーションボタン（青→緑）
- モダンなアイコン（Lucide React）
- レスポンシブデザイン

---

## 📊 現在の状態

### ✅ 実装済み機能
- 認証・認可システム
- ダッシュボード（KPI、グラフ、アクティビティ）
- プロジェクト/フォルダ管理
- 取引先/入居者管理
- 入金消込（AIマッチング）
- 請求書管理
- 見積書管理
- 取引先管理
- 経費管理
- 設定管理
- 初期設定

### 🚧 未実装機能（UIのみ）
- AI通帳読み取り（Beta）
- 領収書発行

### 🔄 今後の拡張予定
- LINE Messaging API連携（スキーマに準備済み）
- 請求書の分割請求機能（スキーマに準備済み）

---

## 📝 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# 型チェック
npm run type-check

# テスト実行
npm run test

# Prismaマイグレーション
npx prisma migrate dev

# Prismaクライアント生成
npx prisma generate
```

---

## 🌐 アクセスURL

- **開発環境**: http://localhost:3000
- **ダッシュボード**: http://localhost:3000/dashboard
- **入金消込**: http://localhost:3000/reconcile
- **ログイン**: http://localhost:3000/sign-in
- **登録**: http://localhost:3000/sign-up
